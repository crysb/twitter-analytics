---
title: "Twitter Analytics - Arctic Data Center"
date: "Last updated June 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r load-packages, echo=FALSE,results=FALSE,message=FALSE}
library(readr)
library(tidyr)
library(knitr)
library(ggplot2)
library(syuzhet)
library(rtweet)
library(dplyr)
library(tidytext)
library(kableExtra)
library(ggraph)
library(formattable)
library(data.table)
library(dendroTools)
library(cowplot)
library(tm)
library(tokenizers)
library(tidyverse)
library(wordcloud)
library(SnowballC)
library(RColorBrewer)
library(wordcloud2)
library(widyr)
library(igraph)
library(topicmodels)
library(DataCombine)
library(ggThemeAssist)
library(quanteda)
library(data.table)
library(lubridate)
library(textclean)
library(gridExtra)
library(grid)
library(lattice)
library(gtable)
```

## Arctic Data Center Twitter Metrics

This report contains information about the Arctic Data Center's Twitter account, @ArcticDataCtr, and how effective it is at engaging a wider audience of Arctic researchers, students, and other data organizations.

```{r manually-gathered-data, echo=FALSE,results=FALSE,message=FALSE}
twitter_summary_metrics <- read_csv("~/Documents/Twitter Analytics/Raw Data/twitter-summary-metrics.csv")
twitter_summary_metrics$Date <-as.Date(twitter_summary_metrics$Date) 
```
```{r downloaded-scraped-data, echo=FALSE}

#Getting the timeline of tweets from rtweet
ADC_raw <- get_timeline("@ArcticDataCtr", n= 3200)
ADC_raw$status_id <-as.numeric(ADC_raw$status_id)
ADC_raw <- select(ADC_raw, status_id, created_at, text, display_text_width, reply_to_status_id, reply_to_screen_name,
                  is_retweet, favorite_count, retweet_count, hashtags, media_type, mentions_screen_name)

#If you want to export the tweet timeline as a .csv, run the following commented lines of code.
#ADC <- apply(ADC,2,as.character)
#write.csv(ADC,"/Users/mclean/Downloads/ADC-Tweet-Data.csv", row.names = FALSE)

#Joining rtweet data to downloaded twitter data

files <- list.files("~/Documents/Twitter Analytics/Raw Data/Monthly/",pattern="twitter-metrics-",full.names=TRUE)
ADC_downloaded <- lapply(files, read.csv, stringsAsFactors = F)
ADC_downloaded_merge <- do.call(rbind, ADC_downloaded) %>% 
  select(Tweet.id, impressions, engagements, engagement.rate, replies, user.profile.clicks, url.clicks,
         hashtag.clicks, detail.expands, permalink.clicks, media.views, media.engagements)

ADC <- left_join(ADC_raw, ADC_downloaded_merge, by = c("status_id" = "Tweet.id"))
```
```{r cleaning-data, echo=FALSE}

#getting rid of any HTML symbols so I don't have things like &amp; in the text of the tweets
ADC$text <-replace_html(ADC$text,symbol=TRUE)

#creating two columns Date AND Time rather than "created at" so that I can subset by Hour or Month
ADC$posdate <- as.POSIXct(ADC$created_at,format="%Y:%m:%d %H:%M:%S")
ADC$posdate <- with_tz(ADC$posdate, tzone = "America/Los_Angeles")
ADC$Time <- format(as.POSIXct(ADC$posdate,format="%Y:%m:%d %H:%M:%S"),"%H:%M:%S")
ADC$Date <- format(as.POSIXct(ADC$posdate,format="%Y:%m:%d %H:%M:%S"),"%Y:%m:%d")
ADC$Hour<-format(strptime(ADC$Time,"%H:%M:%S"),'%H')
ADC$MonthYr<-format(strptime(ADC$Date,"%Y:%m:%d"),'%Y:%m')

#Creating an organic tweet list
#Remove retweets
ADC_tweets_organic <- ADC[ADC$is_retweet==FALSE, ] 
# Remove replies
ADC_tweets_organic <- subset(ADC_tweets_organic, is.na(ADC_tweets_organic$reply_to_status_id)) 

#formatting changes for the date and for the list of hashtags
ADC_tweets_organic$created_at <-as.character.Date(ADC_tweets_organic$created_at) 
ADC_tweets_organic$hashtags <- lapply(ADC_tweets_organic$hashtags, paste0, collapse = ", ")

#summarizing the number of engagements by month
mcount_tweets<-ADC_tweets_organic %>%  
  group_by(MonthYr) %>%
  summarize(n = n())

mcount_engagements<-ADC_tweets_organic %>%  
  group_by(MonthYr) %>%
  summarize(engagement_sum = sum(engagements,na.rm=TRUE))

mcount_impressions<-ADC_tweets_organic %>%  
  group_by(MonthYr) %>%
  summarize(impressions_sum = sum(impressions,na.rm=TRUE))

mcount_retweets<-ADC_tweets_organic %>%  
  group_by(MonthYr) %>%
  summarize(retweets_sum = sum(retweet_count,na.rm=TRUE))

mcount_faves<-ADC_tweets_organic %>%  
  group_by(MonthYr) %>%
  summarize(faves_sum = sum(favorite_count,na.rm=TRUE))

bymonth<-cbind(mcount_tweets,mcount_engagements$engagement_sum,mcount_impressions$impressions_sum, mcount_faves$faves_sum,mcount_retweets$retweets_sum)
names(bymonth)[3] <- "Meng_sum"
names(bymonth)[4] <- "Mimp_sum"
names(bymonth)[5] <- "Mfave_sum"
names(bymonth)[6] <- "Mretweet_sum"

bymonth$year<-substr(bymonth$MonthYr, start = 1, stop = 4)
bymonth$month<-substr(bymonth$MonthYr, start = 6, stop = 7)

bymonth$date<-paste(bymonth$year, bymonth$month, sep="-")
bymonth$date <- as.Date(paste(bymonth$date,"-01",sep=""))

bymonth$normalengagement<-(bymonth$Meng_sum/bymonth$n)
bymonth$normalimpressions<-(bymonth$Mimp_sum/bymonth$n)
bymonth$normalfaves<-(bymonth$Mfave_sum/bymonth$n)
bymonth$normalRTs<-(bymonth$Mretweet_sum/bymonth$n)

#Keeping ONLY the retweets
ADC_retweets <- ADC[ADC$is_retweet==TRUE, ] 

#Keeping ONLY the replies
ADC_replies <- subset(ADC, !is.na(ADC$reply_to_status_id))

```
```{r creating-custom-theme-colors, echo=FALSE,results=FALSE,message=FALSE}
theme_ADC<- function() {
  theme_bw(base_size=12,base_family="Helvetica") %+replace%
    theme(
      plot.title=element_text(size=11, face="bold",margin=margin(10,0,10,0),color="#1D244F"),
      plot.subtitle = element_text(size=10,margin=margin(0,0,10,0),color="#1D244F"),
        axis.text.x = element_text(angle=50, size=8, vjust=0.5, color="#1D244F"),
        axis.text.y = element_text(size=8, color="#1D244F"),
        axis.title.x = element_text(color="#1D244F",vjust=-.5,size=10),
        axis.title.y = element_text(color="#1D244F",angle=90,vjust=.5,size=10),
        panel.background=element_rect(fill="white"),
        axis.line = element_line(color="#1D244F"),
      panel.grid.major = element_line(colour = "white", size = 0.2), 
    panel.grid.minor = element_line(colour = "white", size = 0.5),
    )
}

ADC_colors <- c(
  `navy`="#1D244E",
  `light blue`="#B3E1E7",
  `green`="#19B369",
  `light green`="#79FD81",
  `teal`="#146660",
  `dark teal`="#1B887E",
  `grey`="#767171",
  `black`="#000000")
```

### How has the Arcitc Data Center's Twitter account increased its reach over time?
These first two graphs illustrate the number of organic Tweets each month (that is, not Retweets or replies) and the number of followers @ArcticDataCtr has gained each month. The number of followers gained does not include any followers lost, and represents the net gain (or loss) of followers.
```{r monthly-tweets, echo=FALSE,results=FALSE,message=FALSE}
monthlytweets<-ggplot(data = bymonth, aes(x=date, y=n)) +
  geom_line(color="#156760",size=1.5)+
  labs(title='Number of Monthly Tweets',
       x="Date",
       y="Number of Tweets")+
    stat_smooth(method="lm", se=FALSE, color="#B4E6EA",size=1)

monthlytweets<-monthlytweets+theme_ADC()
```
```{r followers, echo=FALSE}
followers<-ggplot(data = twitter_summary_metrics, aes(x=Date, y=New_Followers)) +
  geom_line(color="#156760",size=1.5)+
  labs(title='Followers Gained Each Month',
       x="Date",
       y="Followers Gained")+
    stat_smooth(method="lm", se=FALSE, color="#B4E6EA",size=1)

followers<-followers+theme_ADC()

```
```{r basic-graphs, echo=FALSE}
plot_grid(monthlytweets,followers,
          ncol=2)
```

These next two graphs dig into the metrics associated with each Tweet. Every organic Tweet has a certain number of engagements (that is, the number of times users interact with the Tweet) and impressions (the number of times users are served that Tweet in their timeline). The data presented are normalized on a per Tweet basis because of course there will be more engagements and impressions as the quantity of Tweets increases.
```{r normal-impressions-engagements, echo=FALSE}

tweetengagements<-ggplot(data = bymonth, aes(x=date, y=normalengagement)) +
  geom_point(color="#156760",size=2.5)+
  labs(title='Engagements per Tweet',
       subtitle = '',
       x="Time",
       y="Engagements per Tweet")+
  stat_smooth(method="lm", se=FALSE, color="#B4E6EA",size=1)

tweetengagements<-tweetengagements+theme_ADC()

tweetimpressions<-ggplot(data = bymonth, aes(x=date, y=normalimpressions)) +
  geom_point(color="#156760",size=2.5)+
  labs(title='Impressions per Tweet',
       subtitle = '',
       x="Time",
       y="Impressions")+
  stat_smooth(method="lm", se=FALSE, color="#B4E6EA",size=1)

tweetimpressions<-tweetimpressions+theme_ADC()
```
```{r more-depth--graphs, echo=FALSE}
plot_grid(tweetengagements,tweetimpressions,
          ncol=2)
```

The number of engagements includes all actions that a user could take with a Tweet, including Retweeting, clicking anywhere on the Tweet, or favoriting the Tweet. To dig further into those engagements, the following graphs show the number of likes and retweets on a per Tweet basis.
```{r normal-faves-likes, echo=FALSE}

tweetfaves<-ggplot(data = bymonth, aes(x=date, y=normalfaves)) +
  geom_point(color="#156760",size=2.5)+
  labs(title='Mean Monthly Favorites per Tweet',
       subtitle = '',
       x="Time",
       y="Favorites per Tweet")+
  stat_smooth(method="lm", se=FALSE, color="#B4E6EA",size=1)

tweetfaves<-tweetfaves+theme_ADC()

tweetRTs<-ggplot(data = bymonth, aes(x=date, y=normalRTs)) +
  geom_point(color="#156760",size=2.5)+
  labs(title='Mean Monthly Retweets per Tweet',
       subtitle = '',
       x="Time",
       y="Retweets")+
  stat_smooth(method="lm", se=FALSE, color="#B4E6EA",size=1)

tweetRTs<-tweetRTs+theme_ADC()
```
```{r more-engagement-graphs, echo=FALSE}
plot_grid(tweetfaves,tweetRTs,
          ncol=2)
```

### What content is liked and retweeted most often?
Understanding what content resonates with our audience of Arctic researchers is an important part of running a successful and engaging Twitter account. The following tables illustrate the Tweets that have been impactful to our audience.

#### Top 5: Most Liked Tweets
```{r twitter-faves, echo=FALSE}

ADC_tweets_organic <- ADC_tweets_organic %>% arrange(-favorite_count)
ADC_tweets_fav <- select(ADC_tweets_organic,text,created_at,favorite_count, hashtags)
ADC_tweets_fav <- ADC_tweets_fav[1:5,]

ADC_tweets_fav %>% 
  kable(col.names=c("Tweet","Date and Time","Likes", "Hashtags Used")) %>% 
  kable_styling() %>% 
  column_spec(2,width="10em") %>% 
  column_spec(1,width="35em")
```

#### Top 5: Most Retweeted Tweets
```{r twitter-retweets, echo=FALSE}

ADC_tweets_organic <- ADC_tweets_organic %>% arrange(-retweet_count)
ADC_tweets_retweets <- select(ADC_tweets_organic,text,created_at, retweet_count,hashtags)
ADC_tweets_retweets <- ADC_tweets_retweets[1:5,]

ADC_tweets_retweets %>% 
  kable(col.names=c("Tweet","Date and Time","Retweets", "Hashtags Used")) %>% 
  kable_styling() %>% 
  column_spec(2,width="10em") %>% 
  column_spec(1,width="35em") 

```

#### Top 5: Most Engaging Tweets
The number of engagements a Tweet gets is the total number of times a user interacted with a Tweet. An interaction is defined as the user clicking anywhere on the Tweet, including Retweets, replies, follows, likes, links, cards, hashtags, embedded media, username, profile photo, or Tweet expansion.
```{r twitter-engagements, echo=FALSE}

ADC_tweets_organic <- ADC_tweets_organic %>% arrange(-engagements)
ADC_tweets_engagements <- select(ADC_tweets_organic,text,created_at, engagements,hashtags)
ADC_tweets_engagements <- ADC_tweets_engagements[1:5,]

ADC_tweets_engagements %>% 
  kable(col.names=c("Tweet","Date and Time","Engagements", "Hashtags Used")) %>% 
  kable_styling() %>% 
  column_spec(2,width="10em") %>% 
  column_spec(1,width="35em")

```

#### Top 5: Most Impressionistic Tweets
The number of impressions that a Tweet generates is the number of times users are served @ArcticDataCtr tweets in their timeline, search results, or from @ArcticDataCtr's profile.
```{r twitter-impressions, echo=FALSE}

ADC_tweets_organic <- ADC_tweets_organic %>% arrange(-impressions)
ADC_tweets_impressions <- select(ADC_tweets_organic,text,created_at, impressions,hashtags)
ADC_tweets_impressions <- ADC_tweets_impressions[1:5,]

ADC_tweets_impressions %>% 
  kable(col.names=c("Tweet","Date and Time","Impressions", "Hashtags Used")) %>% 
  kable_styling() %>% 
  column_spec(2,width="10em") %>% 
  column_spec(1,width="35em")

```


#### Distribution of replies, retweets, and organic tweets
Analyzing the ratio of replies, retweets and organic tweets can tell you a great deal about the type of account you’re analysing. No one likes a Twitter account that exclusively retweets for instance, without any individual content. Finding a good ratio of replies, retweets and organic tweets is therefore a key metric to monitor if one wishes to improve the performance of an account.
```{r twitter-ratio, echo=FALSE}

tweet_ratio <- data.frame(
  category=c("Retweets", "Replies", "Organic Tweets"),
  count=c(nrow(ADC_retweets), nrow(ADC_replies), nrow(ADC_tweets_organic))
)

# Adding calculated data columns
tweet_ratio$fraction = tweet_ratio$count / sum(tweet_ratio$count)
tweet_ratio$percentage = tweet_ratio$count / sum(tweet_ratio$count) * 100
tweet_ratio$ymax = cumsum(tweet_ratio$fraction)
tweet_ratio$ymin = c(0, head(tweet_ratio$ymax, n=-1))

#Rounding to two decimal points
tweet_ratio<-round_df(tweet_ratio,2)

#Creating the legend
TweetType<-paste(tweet_ratio$category, tweet_ratio$percentage, "%")

#Plotting the data
ggplot(tweet_ratio,aes(ymax=ymax, ymin=ymin, xmax=4,xmin=3,fill=TweetType))+
  geom_rect()+
  coord_polar(theta="y")+
  xlim(c(2,4))+
  theme_void()+
  theme(legend.position = "right")+ 
  scale_fill_manual(values=c( "#79FDB1","#B4E6EA","#1D244E"))
```

### When is the best time of day to post tweets?
Only organic tweets are included in this analysis because engagements and impressions are not calculated the same way for retweets.
```{r time-of-day, echo=FALSE,results=FALSE,warning=FALSE, message=FALSE}
#trying to normalize data by number of tweets
count_tweets<-ADC_tweets_organic %>%  
  group_by(Hour) %>%
  summarize(n = n())

count_engagements<-ADC_tweets_organic %>%  
  group_by(Hour) %>%
  summarize(engagement_sum = sum(engagements,na.rm=TRUE))

count_impressions<-ADC_tweets_organic %>%  
  group_by(Hour) %>%
  summarize(impressions_sum = sum(impressions,na.rm=TRUE))

byhour<-cbind(count_tweets,count_engagements$engagement_sum,count_impressions$impressions_sum)
names(byhour)[3] <- "eng_sum"
names(byhour)[4] <- "imp_sum"

byhour$normalengagement<-(byhour$eng_sum/byhour$n)
byhour$normalimpressions<-(byhour$imp_sum/byhour$n)

normal_engagements<-ggplot(data= byhour, aes(x=Hour, y=normalengagement)) +
  geom_col(fill="#156760", color="#79FDB1")+
  labs(title='Time of Tweet vs Engagements (Normalized)',
       x="Time",
       y="Normalized Engagements")

normal_engagements<-normal_engagements+theme_ADC()

tweettime_engagements<-ggplot(data = ADC_tweets_organic, aes(x=Hour, y=engagements)) +
  geom_col(fill="#156760", color="#79FDB1")+
  labs(title='Time of Tweet vs Engagements',
       x="Time",
       y="Number of Engagements")

tweettime_engagements<-tweettime_engagements+theme_ADC()

normal_impressions<-ggplot(data= byhour, aes(x=Hour, y=normalimpressions)) +
  geom_col(fill="#79FDB1", color="#156760")+
  labs(title='Time of Tweet vs Impressions (Normalized)',
       x="Time",
       y="Normalized Impressions")

normal_impressions<-normal_impressions+theme_ADC()

tweettime_impressions<-ggplot(data = ADC_tweets_organic, aes(x=Hour, y=impressions)) +
  geom_col(fill="#79FDB1", color="#156760")+
  labs(title='Time of Tweet vs Impressions',
       x="Time",
       y="Number of Impressions")

tweettime_impressions<-tweettime_impressions+theme_ADC()

plot_grid(tweettime_engagements,normal_engagements, tweettime_impressions, normal_impressions,
          ncol=2,nrow=2,
          rel_widths = c(1.5,1.5,1.5,1.5))

```

### Data Collection - Summary

Data was collected manually on the first of the month from https://analytics.twitter.com/user/arcticdatactr/home. In addition to parameters not necessary to this analysis, this summary file contains:

* month: month of Tweet information
* year: year of Tweet information
* tweets: number of Tweets that month
* profile-visits: number of times users visited the @ArcticDataCtr profile page
* new-followers: number of new followers gained (gross new followers; does not account for followers lost)
* tweet-impressions: number of times users are served @ArcticDataCtr tweets in timeline, search results, or from the profile
* mentions: number of times @ArcticDataCtr was mentioned in tweets
* number-followers: number of followers, manually copied from https://twitter.com/arcticdatactr. 
    * Number of followers is the only piece of data in this file that is only available from Twitter at the time you access the site i.e. it is not made available with the rest of the data in this dataset. Thus, there are NAs for dates prior to the time I started to collect this data or for dates before I realized this data was ephemeral.

### Data Collection - Monthly Tweets

Data was scraped using the R package rtweet. In addition to parameters not necessary to this analysis, this data contains the following parameters:

* status_id: the identifier for the Tweet, which can be used to find the permanent URL
* created_at: the time the Tweet was sent (GMT)
* text: the text (content) of the Tweet
* display_text_width: how many characters are in the Tweet
* reply_to_status_id: whether the Tweet was a reply
* reply_to_screen_name: who the Tweet was a reply to
* is_retweet: whether the Tweet was a retweet
* favorite_count: number of likes
* retweet_count: number of retweets
* hashtags: what hashtags were used in the Tweet content
* media_type: what type of media was attached to the Tweet
* mentions_screen_name: what other Twitter accounts were mentioned (@) in the Tweet

Additionally, Tweet-level data was also downloaded from https://analytics.twitter.com/user/arcticdatactr/home, and in addition to parameters not necessary to this analysis, this data contains the following additional parameters:

* Tweet.id: the identifier for the Tweet, which can be used to find the permanent URL
* impressions: number of times users are served the tweet in timeline, search results, or from the @ArcticDataCtr profile
* engagements: total number of times a user interacted with a Tweet. Clicks anywhere on the Tweet, including Retweets, replies, follows, likes, links, cards, hashtags, embedded media, username, profile photo, or Tweet expansion
* engagement.rate: number of engagements divided by impressions
* replies: number of replies that Tweet generated
* user.profile.clicks: number of times a user clicked on the @ArcticDataCtr profile from that particular tweet
* URL.clicks: number of times that URL within the tweet was clicked
* hashtag.clicks: number of times any of your hashtags were clicked from that tweet
* detail.expands: number of times users clicked 'see more' on your tweet
* permalink.clicks: clicks on the Tweet permalink
* follows: times a user followed you directly from the Tweet
* media.views: number of times media attached to the Tweet is viewed
* media.engagements: an interaction on a tweet that has a piece of media (photo, vine, other video, etc) in it

Data scraped from rtweet and downloaded from the Twitter metrics page were joined based on the Tweet id / status_id variable.